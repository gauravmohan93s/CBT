<template>
  <header
    v-show="!isFullscreen"
    class="border"
  >
    <nav>
      <div class="flex w-full h-14 items-center">
        <span class="font-bold text-2xl sm:text-[1.76rem] md:text-[1.9rem] py-1.5 px-2">
          <NuxtLink
            to="/"
            class="text-primary"
          >
            MockCBT
            <span class="text-muted-foreground text-sm sm:text-[.9rem] md:text-base">v{{ appVersion }}</span>
          </NuxtLink>
        </span>
        <div class="hidden min-[73.5rem]:flex items-center mx-auto">
          <template
            v-for="item in visibleNavItems"
            :key="item.title"
          >
            <NuxtLink
              :to="item.href"
              class="outline-hidden rounded-sm shadow-xs transition-all
              focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] focus-visible:border"
            >
              <template #default="{ isActive }">
                <div
                  class="flex gap-1.5 justify-center"
                  :class="[navigationMenuTriggerStyle(), 'h-full', isActive ? 'text-primary' : '']"
                >
                  <Icon
                    :name="item.icon"
                    size="1.3rem"
                  />
                  <span class="text-lg font-bold text-nowrap">
                    {{ item.title }}
                  </span>
                </div>
              </template>
            </NuxtLink>
          </template>
        </div>
        
        <div class="flex gap-2.5 sm:gap-3 xl:gap-4 items-center h-14 ml-auto min-[43rem]:ml-2 pr-4 xl:pr-8">
          
          <template v-if="hasAuth">
            <BaseButton
              variant="outline"
              size="sm"
              class="gap-2"
              @click="handleLogout"
            >
              <Icon name="mdi:logout" size="1.2rem" />
              Logout
            </BaseButton>
          </template>
          <template v-else>
            <NuxtLink to="/login">
              <BaseButton
                variant="default"
                size="sm"
                class="bg-primary text-primary-foreground hover:bg-primary/90"
              >
                Login
              </BaseButton>
            </NuxtLink>
          </template>

          <BaseButton
            variant="outline"
            size="icon"
            title="Toggle Fullscreen"
            class="text-primary hover:text-primary/90"
            icon-name="material-symbols:fullscreen"
            icon-size="1.5rem"
            @click="toggleFullscreen()"
          />
        </div>
      </div>
    </nav>
  </header>
</template>

<script lang="ts" setup>
import { navigationMenuTriggerStyle } from '#layers/shared/app/components/ui/navigation-menu'
import { getDashboardPath, type UserRole } from '#layers/shared/shared/roles'

const user = useSupabaseUser()
const session = useSupabaseSession()
const role = useUserRole()
const supabase = useSupabaseClient()
const router = useRouter()
const route = useRoute()

const handleLogout = async () => {
  await supabase.auth.signOut()
  router.push('/login')
}

const { isFullscreen, toggle: toggleFullscreen } = useFullscreen()

const publicRuntimeConfig = useRuntimeConfig().public
const appVersion = publicRuntimeConfig.projectVersion

const hasAuth = computed(() => Boolean(user.value || session.value?.user))

type NavItem = {
  title: string
  href: string
  icon: string
}

const dashboardItem = computed<NavItem | null>(() => {
  if (!role.value) return null
  return {
    title: 'Dashboard',
    href: getDashboardPath(role.value as UserRole),
    icon: 'material-symbols:dashboard-rounded',
  }
})

const pdfCropperItem: NavItem = {
  title: 'PDF Cropper',
  href: '/pdf-cropper',
  icon: 'material-symbols:crop-rounded',
}

const testInterfaceItem: NavItem = {
  title: 'Test Interface',
  href: '/cbt/interface',
  icon: 'line-md:computer',
}

const resultsItem: NavItem = {
  title: 'Test Results',
  href: '/cbt/results',
  icon: 'material-symbols:bar-chart-4-bars-rounded',
}

const answerKeyItem: NavItem = {
  title: 'Generate Answer Key',
  href: '/cbt/generate-answer-key',
  icon: 'mdi:script-text-key-outline',
}

const visibleNavItems = computed<NavItem[]>(() => {
  if (!hasAuth.value || !role.value) return []

  const items: NavItem[] = []
  if (dashboardItem.value) items.push(dashboardItem.value)

  if (role.value === 'student') {
    items.push(testInterfaceItem, resultsItem)
    return items
  }

  if (role.value === 'test_centre_admin') {
    items.push(pdfCropperItem, testInterfaceItem, resultsItem, answerKeyItem)
    return items
  }

  items.push(pdfCropperItem, testInterfaceItem, resultsItem, answerKeyItem)
  return items
})
</script>
